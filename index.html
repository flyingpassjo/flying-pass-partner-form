<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flying Pass 提携情報登録</title>
<link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
<link rel="dns-prefetch" href="//lh3.googleusercontent.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Noto Sans JP', sans-serif; background: #FAFBFC; color: #0F172A; }
a { color: inherit; }

.nav {
  background: white; box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  position: sticky; top: 0; z-index: 100; padding: 14px 24px;
  display: flex; justify-content: space-between; align-items: center;
}
.nav-logo { display: flex; align-items: center; gap: 10px; }
.nav-logo-img { height: 30px; width: auto; max-width: 220px; object-fit: contain; display: block; }
.nav-btn {
  background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
  color: white; border: 2px solid #FCA5A5; padding: 11px 22px;
  border-radius: 12px; font-weight: 900; font-size: 13px; cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif;
}
.nav-back {
  background: none; border: none; font-size: 14px; color: #64748B; cursor: pointer;
  font-weight: 600; font-family: 'Noto Sans JP', sans-serif;
}
.banner { background: #DC2626; color: white; text-align: center; padding: 10px 16px; font-size: 13px; font-weight: 700; }

.hero { background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 100%); color: white; padding: 60px 24px; text-align: center; }
.hero h1 { font-size: clamp(22px, 5vw, 34px); font-weight: 900; line-height: 1.4; margin-bottom: 14px; }
.hero p { font-size: 14px; opacity: 0.85; line-height: 1.9; max-width: 680px; margin: 0 auto; }

.container { max-width: 760px; margin: 0 auto; padding: 28px 20px; }
.info-card { background: white; border-radius: 14px; padding: 20px; border: 1px solid #E2E8F0; box-shadow: 0 2px 8px rgba(0,0,0,0.04); line-height: 1.9; color: #334155; }
.cta-box {
  background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
  border-radius: 16px; padding: 30px 24px; text-align: center; color: white; margin-top: 20px;
}
.cta-btn {
  background: white; color: #B91C1C; border: 2px solid #FCA5A5; padding: 14px 34px;
  border-radius: 12px; font-weight: 900; font-size: 16px; cursor: pointer; margin-top: 14px;
}

.footer { background: #0F172A; color: #94A3B8; padding: 24px; text-align: center; font-size: 12px; }
.partner-banner { background: #0F172A; border-radius: 16px; padding: 20px; margin-bottom: 14px; color: white; }
.partner-banner-logo { display: inline-flex; align-items: center; margin-bottom: 14px; overflow: hidden; }
.partner-banner-logo img { height: 28px; width: auto; max-width: 240px; object-fit: contain; display: block; }
.partner-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 8px; }
.partner-link {
  display: block; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.16);
  border-radius: 10px; padding: 10px 12px; font-size: 12px; color: #E2E8F0; text-decoration: none;
}

.form-hero { background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 100%); color: white; padding: 36px 24px; text-align: center; }
.form-hero h2 { font-size: clamp(18px, 4vw, 24px); font-weight: 900; margin-bottom: 8px; }
.form-hero p { font-size: 13px; opacity: 0.85; }

.form-container { max-width: 640px; margin: 0 auto; padding: 24px 20px 60px; }
.form-section {
  background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px;
  border: 1px solid #E2E8F0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.form-section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
.form-section-num {
  background: #DC2626; color: white; width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 800;
  font-family: 'Outfit', sans-serif;
}
.form-section-header h3 { font-size: 16px; font-weight: 800; }

.form-field { margin-bottom: 16px; }
.form-field label { display: block; font-size: 14px; font-weight: 700; margin-bottom: 6px; }
.form-field .req { color: #DC2626; }
.form-input {
  width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #E2E8F0;
  font-size: 14px; outline: none; font-family: 'Noto Sans JP', sans-serif; background: white;
}
.form-input:focus { border-color: #DC2626; }
.form-hint { font-size: 11px; color: #94A3B8; margin-top: 4px; }
.postal-row { display: flex; gap: 8px; align-items: center; }
.postal-btn {
  background: #0F172A; color: white; border: none; border-radius: 8px; padding: 10px 14px;
  font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; white-space: nowrap;
}
.postal-btn:disabled { background: #CBD5E1; cursor: not-allowed; }

.benefit-note {
  background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 10px; padding: 14px;
  margin-bottom: 20px; font-size: 13px; color: #334155; line-height: 1.7;
}
.min-amount { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.min-amount span { font-size: 14px; font-weight: 600; white-space: nowrap; }
.benefit-row {
  display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 10px; margin-bottom: 8px;
  border: 1px solid #E2E8F0; background: #F8FAFC; flex-wrap: wrap; transition: all 0.2s;
}
.benefit-row.active { background: #FEF2F2; border-color: #FECACA; }
.benefit-label { display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1 1 auto; min-width: 160px; }
.benefit-label input { accent-color: #DC2626; width: 18px; height: 18px; }
.benefit-label span { font-size: 14px; font-weight: 600; color: #475569; }
.benefit-row.active .benefit-label span { color: #DC2626; }
.benefit-max { display: flex; align-items: center; gap: 6px; }
.benefit-max span { font-size: 12px; color: #94A3B8; white-space: nowrap; }
.benefit-max input {
  width: 80px; padding: 6px 8px; font-size: 13px; text-align: right;
  border: 1px solid #E2E8F0; border-radius: 8px; outline: none; font-family: 'Noto Sans JP', sans-serif;
}
.benefit-tip {
  font-size: 13px; color: #DC2626; font-weight: 600; margin-top: 12px;
  padding: 10px 14px; background: #FEF2F2; border-radius: 8px; line-height: 1.6;
}

.schedule-toggle { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
.radio-opt {
  display: flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 10px; cursor: pointer;
  font-size: 14px; font-weight: 600; border: 2px solid #E2E8F0; background: white; color: #475569;
}
.radio-opt.active { border-color: #DC2626; background: #FEF2F2; color: #DC2626; }
.radio-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #CBD5E1; }
.radio-opt.active .radio-dot { border: 5px solid #DC2626; }
.time-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.time-select {
  padding: 8px 12px; border: 1px solid #E2E8F0; border-radius: 8px;
  font-size: 14px; font-family: 'Noto Sans JP', sans-serif; outline: none; background: white;
}
.time-select-small { padding: 6px 8px; font-size: 13px; width: 90px; }
.time-label { font-size: 11px; color: #94A3B8; }
.break-check { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; }
.break-check input { accent-color: #DC2626; width: 16px; height: 16px; }
.break-times { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding-left: 24px; }

.holiday-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.holiday-btn {
  padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer;
  border: 1px solid #E2E8F0; background: white; color: #475569; font-family: 'Noto Sans JP', sans-serif;
}
.holiday-btn.active { border: 2px solid #DC2626; background: #FEF2F2; color: #DC2626; }
.holiday-btn.nenkyu.active { border: 2px solid #059669; background: #ECFDF5; color: #059669; }

.weekly-row {
  display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 10px; border: 1px solid #E2E8F0;
  margin-bottom: 8px; flex-wrap: wrap; background: white;
}
.weekly-row.closed { background: #F8FAFC; }
.weekly-day { font-weight: 700; font-size: 14px; width: 24px; }
.weekly-day.off { color: #94A3B8; }
.weekly-close-label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #94A3B8; cursor: pointer; margin-left: auto; }

.menu-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.menu-num {
  background: #DC2626; color: white; width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0;
}

.target-btns { display: flex; flex-wrap: wrap; gap: 8px; }
.target-btn {
  padding: 10px 18px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer;
  border: 1px solid #E2E8F0; background: white; color: #475569; font-family: 'Noto Sans JP', sans-serif;
}
.target-btn.active { border: 2px solid #DC2626; background: #FEF2F2; color: #DC2626; }

.check-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
.check-chip {
  display: grid; grid-template-columns: 18px minmax(0, 1fr); align-items: start; column-gap: 10px;
  border: 1px solid #DDE4EE; border-radius: 14px; background: #FAFBFF; padding: 12px 14px; font-size: 13px;
  line-height: 1.4; color: #1F2937; cursor: pointer;
}
.check-chip input {
  appearance: none; -webkit-appearance: none; width: 18px; height: 18px; margin: 1px 0 0;
  border-radius: 6px; border: 1.5px solid #C7D2E2; background: white; position: relative;
}
.check-chip input:checked { border-color: #3182F6; background: #3182F6; }
.check-chip input:checked::after {
  content: ''; position: absolute; left: 5px; top: 1px; width: 5px; height: 10px;
  border: solid #fff; border-width: 0 2px 2px 0; transform: rotate(45deg);
}
.check-chip.active { border-color: #3182F6; background: #EFF5FF; color: #1B4DB8; font-weight: 700; }
.check-chip-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.agree-list {
  background: #F8FAFC; border-radius: 10px; padding: 16px; font-size: 13px;
  color: #334155; line-height: 1.9; margin-bottom: 16px;
}
.agree-list ol { margin: 0; padding-left: 18px; }
.agree-check {
  display: grid; grid-template-columns: 19px minmax(0, 1fr); align-items: start; column-gap: 10px;
  cursor: pointer; padding: 13px 14px; border-radius: 12px; border: 1.5px solid #DDE4EE; background: #FBFCFF;
}
.agree-check.active { border-color: #3182F6; background: #EFF5FF; box-shadow: 0 2px 12px rgba(49,130,246,0.14); }
.agree-check input {
  appearance: none; -webkit-appearance: none; width: 19px; height: 19px; margin: 1px 0 0;
  border-radius: 6px; border: 1.5px solid #C7D2E2; background: white; position: relative;
}
.agree-check input:checked { border-color: #3182F6; background: #3182F6; }
.agree-check input:checked::after {
  content: ''; position: absolute; left: 5px; top: 1px; width: 5px; height: 10px;
  border: solid #fff; border-width: 0 2px 2px 0; transform: rotate(45deg);
}
.agree-check span { font-size: 14px; font-weight: 700; color: #344256; }

.submit-btn {
  width: 100%; padding: 16px 32px; border-radius: 12px; font-size: 16px; font-weight: 800;
  border: none; color: white; cursor: pointer; font-family: 'Noto Sans JP', sans-serif;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.submit-btn.ready { background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); box-shadow: 0 4px 20px rgba(220,38,38,0.3); }
.submit-btn.disabled { background: #CBD5E1; cursor: not-allowed; }
.submit-hint { text-align: center; font-size: 12px; color: #94A3B8; margin-top: 10px; }
.submit-error {
  background: #FEF2F2; border: 1px solid #FECACA; border-radius: 10px; padding: 14px;
  margin-bottom: 16px; font-size: 13px; color: #DC2626; text-align: center;
}

.success-page {
  min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 100%); color: white; padding: 24px; text-align: center;
}
.success-card {
  background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 24px;
  padding: 48px 32px; max-width: 440px; width: 100%; border: 1px solid rgba(255,255,255,0.15);
}
.success-icon {
  width: 72px; height: 72px; background: linear-gradient(135deg, #059669, #10B981);
  border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;
}
.line-btn {
  display: inline-flex; align-items: center; gap: 8px; background: #06C755; color: white; padding: 14px 28px;
  border-radius: 10px; font-size: 14px; font-weight: 700; text-decoration: none;
}
.line-btn-big { width: 100%; justify-content: center; }
.post-upload-status { margin-top: 12px; font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.85); min-height: 20px; }
.post-upload-retry {
  margin-top: 10px; padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.35);
  color: #fff; background: rgba(255,255,255,0.12); font-size: 12px; font-weight: 700; cursor: pointer;
}
.post-upload-retry.hidden { display: none; }
.countdown { font-size: 12px; opacity: 0.7; margin-top: 8px; }
.success-note { margin-top: 24px; font-size: 12px; opacity: 0.75; line-height: 1.7; }

.hidden { display: none !important; }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; }

@media (max-width: 640px) {
  .nav { flex-wrap: wrap; gap: 10px; }
  .nav-logo { width: 100%; }
  .nav-logo-img { height: 24px; max-width: 180px; }
  .nav-btn { width: 100%; text-align: center; }
  .check-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="infoPage">
  <div class="banner">【重要】Flying Pass 本格始動に伴うご案内とご協力のお願い</div>

  <nav class="nav">
    <a class="nav-logo" href="https://flyingjp.net/" target="_blank" rel="noopener noreferrer">
      <img class="nav-logo-img" src="https://lh3.googleusercontent.com/d/1z_KJ-l3SuqBaM5Irb_bBAMNCq8mQuc2x=s3000" alt="FLYING JAPAN">
    </a>
    <button class="nav-btn" onclick="showForm()">情報登録フォームへ →</button>
  </nav>

  <section class="hero">
    <h1>訪日韓国人向け「Flying Pass」<br>提携店舗情報 更新フォーム</h1>
    <p>提携情報の更新にご協力お願いいたします。<br>送信後、画像はLINEにて店舗名と一緒にお送りください。</p>
  </section>

  <div class="container">
    <div class="info-card">
      本フォームは提携店舗様向けの情報更新フォームです。<br>
      基本情報・特典内容・営業時間・旅行者向け利便情報をご入力ください。<br>
      画像はフォーム内ではなく、送信完了後にLINEで送付をお願いいたします。
    </div>

    <div class="cta-box">
      <h3>提携情報の更新にご協力ください</h3>
      <p>以下のフォームからご登録をお願いいたします。</p>
      <button class="cta-btn" onclick="showForm()">情報登録フォームへ進む →</button>
    </div>
  </div>

  <footer class="footer">
    <div style="max-width:760px;margin:0 auto;">
      <div class="partner-banner">
        <a class="partner-banner-logo" href="https://flyingjp.net/" target="_blank" rel="noopener noreferrer">
          <img src="https://lh3.googleusercontent.com/d/1uU92iQ5TQ3hmCd2k4C4bolzhTlDt9-Te=s3000" alt="FLYING JAPAN">
        </a>
        <div class="partner-links">
          <a class="partner-link" href="https://flying-pass.com/" target="_blank" rel="noopener noreferrer">FLYING PASS</a>
          <a class="partner-link" href="https://cafe.naver.com/d2d2d2" target="_blank" rel="noopener noreferrer">NAVER カフェ</a>
          <a class="partner-link" href="https://maps.app.goo.gl/bUgPdXCC78whuixAA" target="_blank" rel="noopener noreferrer">なんば旅行者センター</a>
          <a class="partner-link" href="https://line.me/R/ti/p/@864mbroc" target="_blank" rel="noopener noreferrer">LINE 公式アカウント</a>
          <a class="partner-link" href="https://flyingjp.net/" target="_blank" rel="noopener noreferrer">FLYING JAPAN 公式サイト</a>
          <a class="partner-link" href="https://www.nikkei.com/article/DGXZQOUF177FU0X10C24A6000000/" target="_blank" rel="noopener noreferrer">日経掲載記事</a>
        </div>
      </div>
      <div>&copy; 2026 Flying Japan Inc. All rights reserved.</div>
    </div>
  </footer>
</div>

<div id="formPage" class="hidden">
  <nav class="nav">
    <button class="nav-back" onclick="showInfo()">← 戻る</button>
    <a class="nav-logo" href="https://flyingjp.net/" target="_blank" rel="noopener noreferrer">
      <img class="nav-logo-img" src="https://lh3.googleusercontent.com/d/1z_KJ-l3SuqBaM5Irb_bBAMNCq8mQuc2x=s3000" alt="FLYING JAPAN">
    </a>
  </nav>

  <div class="form-hero">
    <h2>提携店舗 情報登録フォーム</h2>
    <p>Flying Pass プラットフォームに掲載する情報をご入力ください</p>
  </div>

  <div class="form-container">

    <div class="form-section">
      <div class="form-section-header"><div class="form-section-num">1</div><h3>店舗基本情報</h3></div>

      <div class="form-field"><label>会社名（店舗名）<span class="req">*</span></label><input type="text" id="companyName" class="form-input" required></div>
      <div class="form-field"><label>担当者名 <span class="req">*</span></label><input type="text" id="contactName" class="form-input" required></div>
      <div class="form-field"><label>担当者連絡先（LINE 又は 電話番号）<span class="req">*</span></label><input type="text" id="contactInfo" class="form-input" required></div>
      <div class="form-field"><label>メールアドレス <span class="req">*</span></label><input type="email" id="email" class="form-input" required></div>

      <div class="form-field">
        <label>業種 <span class="req">*</span></label>
        <select id="category" class="form-input" required>
          <option value="">選択してください</option>
          <option value="飲食店">飲食店</option>
          <option value="カフェ">カフェ</option>
          <option value="バー・ラウンジ">バー・ラウンジ</option>
          <option value="ショッピング">ショッピング</option>
          <option value="エンターテインメント">エンターテインメント</option>
          <option value="旅行サービス">旅行サービス</option>
          <option value="美容">美容</option>
          <option value="体験・アクティビティ">体験・アクティビティ</option>
          <option value="宿泊">宿泊</option>
          <option value="その他">その他</option>
        </select>
      </div>

      <div class="form-field">
        <label>郵便番号（住所自動入力）</label>
        <div class="postal-row">
          <input type="text" id="postalCode" class="form-input" placeholder="例：5420076" inputmode="numeric" maxlength="8">
          <button type="button" class="postal-btn" id="postalSearchBtn" onclick="lookupPostalCode()">住所検索</button>
        </div>
        <div class="form-hint">ハイフンなし7桁で入力（例: 5420076）</div>
      </div>

      <div class="form-field"><label>地域 <span class="req">*</span></label><input type="text" id="area" class="form-input" required></div>
      <div class="form-field"><label>住所 <span class="req">*</span></label><input type="text" id="address" class="form-input" required></div>
      <div class="form-field"><label>GoogleマップのURL <span class="req">*</span></label><input type="url" id="googleMapsUrl" class="form-input" required></div>
    </div>

    <div class="form-section">
      <div class="form-section-header"><div class="form-section-num">2</div><h3>条件と特典の内容</h3></div>
      <div class="benefit-note">「目に見える特典」の方が高い集客効果が期待できます。</div>

      <div class="form-field">
        <label>利用条件 <span class="req">*</span></label>
        <div class="min-amount">
          <span>お会計</span>
          <input type="number" id="minAmount" class="form-input" style="width:110px;text-align:right" required>
          <span>円以上ご利用時</span>
        </div>
      </div>

      <div class="form-field">
        <label>特典内容 <span class="req">*</span></label>
        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px">1枚につき1特典適用。提供する特典を1つ選択してください。</p>
      </div>

      <div class="benefit-row" id="benefitDiscount" onclick="toggleBenefit('discount')">
        <label class="benefit-label" onclick="event.stopPropagation()"><input type="checkbox" id="chkDiscount" onchange="syncBenefit('discount')"><span>お会計から10%割引</span></label>
        <div class="benefit-max hidden" id="maxDiscount"><span>最大</span><input type="number" id="maxDiscountAmt" class="form-input" onclick="event.stopPropagation()"><span>円まで</span></div>
      </div>
      <div class="benefit-row" id="benefitDrink" onclick="toggleBenefit('drink')">
        <label class="benefit-label" onclick="event.stopPropagation()"><input type="checkbox" id="chkDrink" onchange="syncBenefit('drink')"><span>ドリンク1杯無料</span></label>
        <div class="benefit-max hidden" id="maxDrink"><span>最大</span><input type="number" id="maxDrinkAmt" class="form-input" onclick="event.stopPropagation()"><span>円まで</span></div>
      </div>
      <div class="benefit-row" id="benefitSide" onclick="toggleBenefit('side')">
        <label class="benefit-label" onclick="event.stopPropagation()"><input type="checkbox" id="chkSide" onchange="syncBenefit('side')"><span>サイドメニュー1品無料</span></label>
        <div class="benefit-max hidden" id="maxSide"><span>最大</span><input type="number" id="maxSideAmt" class="form-input" onclick="event.stopPropagation()"><span>円まで</span></div>
      </div>
      <div class="benefit-row" id="benefitSizeUp" onclick="toggleBenefit('sizeUp')">
        <label class="benefit-label" onclick="event.stopPropagation()"><input type="checkbox" id="chkSizeUp" onchange="syncBenefit('sizeUp')"><span>サイズアップ1回無料</span></label>
        <div class="benefit-max hidden" id="maxSizeUp"><span>最大</span><input type="number" id="maxSizeUpAmt" class="form-input" onclick="event.stopPropagation()"><span>円まで</span></div>
      </div>

      <div class="benefit-tip">特典は1つ選択してください。</div>
    </div>

    <div class="form-section">
      <div class="form-section-header"><div class="form-section-num">3</div><h3>営業時間</h3></div>

      <div class="schedule-toggle">
        <div class="radio-opt active" id="optDaily" onclick="setSchedule('daily')"><div class="radio-dot"></div>毎日同じ</div>
        <div class="radio-opt" id="optWeekly" onclick="setSchedule('weekly')"><div class="radio-dot"></div>曜日別</div>
      </div>

      <div id="dailySection">
        <div class="time-row">
          <div><div class="time-label">開店</div><select id="dailyOpen" class="time-select"></select></div>
          <span style="margin-top:16px;color:#94A3B8">〜</span>
          <div><div class="time-label">閉店</div><select id="dailyClose" class="time-select"></select></div>
        </div>

        <label class="break-check"><input type="checkbox" id="hasBreak" onchange="toggleBreak()">休憩時間あり</label>
        <div class="break-times hidden" id="breakTimes">
          <select id="breakOpen" class="time-select time-select-small"></select>
          <span style="color:#94A3B8">〜</span>
          <select id="breakClose" class="time-select time-select-small"></select>
        </div>

        <div style="margin-top:16px">
          <p style="font-size:13px;font-weight:700;margin-bottom:8px">定休日</p>
          <div class="holiday-btns" id="holidayBtns"></div>
        </div>
      </div>

      <div id="weeklySection" class="hidden"></div>
    </div>

    <div class="form-section">
      <div class="form-section-header"><div class="form-section-num">4</div><h3>店舗紹介</h3></div>

      <div class="form-field">
        <label>お店の特徴（一行紹介）<span class="req">*</span></label>
        <input type="text" id="storeIntro" class="form-input" maxlength="80" required>
        <div class="form-hint">位置 + コンセプト + 魅力ポイントを一文で</div>
      </div>

      <div class="form-field">
        <label>一押しメニュー（1〜3つ）</label>
        <div class="menu-row"><div class="menu-num">1</div><input type="text" id="menu1" class="form-input"></div>
        <div class="menu-row"><div class="menu-num">2</div><input type="text" id="menu2" class="form-input"></div>
        <div class="menu-row"><div class="menu-num">3</div><input type="text" id="menu3" class="form-input"></div>
      </div>

      <div class="form-field">
        <label>ターゲット顧客（複数選択可）</label>
        <div class="target-btns" id="targetBtns"></div>
      </div>

      <div class="form-field">
        <label>ウェブサイトおよびSNSのURL</label>
        <input type="url" id="websiteUrl" class="form-input" placeholder="https://...">
      </div>

      <div class="form-field" style="margin-bottom:0">
        <label>店舗関連画像の送付（LINE）</label>
        <div style="background:#ECFDF5;border:1px solid #86EFAC;border-radius:10px;padding:12px;font-size:13px;line-height:1.7;color:#065F46">
          画像はフォーム送信後にLINEでお送りください。<br>
          送信時は必ず <strong>店舗名</strong> を最初に記載してください。<br>
          例: 「○○難波本店 / 外観2枚・メニュー3枚」
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-header"><div class="form-section-num">5</div><h3>旅行者向け利便情報</h3></div>

      <div class="form-field">
        <label>決済手段（Payment Methods）</label>
        <div class="check-grid">
          <label class="check-chip"><input type="checkbox" id="utilPayCredit"><span class="check-chip-text">クレジットカード</span></label>
          <label class="check-chip"><input type="checkbox" id="utilPayPaypay"><span class="check-chip-text">PayPay</span></label>
          <label class="check-chip"><input type="checkbox" id="utilPayAlipay"><span class="check-chip-text">Alipay</span></label>
          <label class="check-chip"><input type="checkbox" id="utilPayCash"><span class="check-chip-text">現金</span></label>
        </div>
      </div>

      <div class="form-field">
        <label>言語対応（Language Support）</label>
        <div class="check-grid">
          <label class="check-chip"><input type="checkbox" id="utilLangKoMenu"><span class="check-chip-text">韓国語メニュー</span></label>
          <label class="check-chip"><input type="checkbox" id="utilLangEnMenu"><span class="check-chip-text">英語メニュー</span></label>
          <label class="check-chip"><input type="checkbox" id="utilLangKoStaff"><span class="check-chip-text">韓国語対応スタッフ</span></label>
        </div>
      </div>

      <div class="form-field" style="margin-bottom:0">
        <label>施設情報（Amenities）</label>
        <div class="check-grid">
          <label class="check-chip"><input type="checkbox" id="utilAmenityWifi"><span class="check-chip-text">無料Wi-Fi</span></label>
          <label class="check-chip"><input type="checkbox" id="utilAmenitySmoking"><span class="check-chip-text">喫煙席あり</span></label>
          <label class="check-chip"><input type="checkbox" id="utilAmenityNoSmoking"><span class="check-chip-text">全席禁煙</span></label>
          <label class="check-chip"><input type="checkbox" id="utilAmenityChildChair"><span class="check-chip-text">子ども用椅子</span></label>
          <label class="check-chip"><input type="checkbox" id="utilAmenityOutlet"><span class="check-chip-text">コンセント</span></label>
        </div>
      </div>
    </div>

    <div class="form-section" style="border-radius:14px">
      <h3 style="font-size:15px;font-weight:800;margin-bottom:14px">同意事項</h3>
      <div class="agree-list">
        <ol>
          <li>登録フォーム提出後、確認完了次第、会員向けページに掲載されます。</li>
          <li>提携内容は店舗スタッフの皆様へ必ず共有してください。</li>
          <li>会員様が特典を受けられないことがないよう、確実な対応をお願いします。</li>
          <li>フライングパス1枚につき、特典は1つご提供ください。</li>
        </ol>
      </div>
      <label class="agree-check" id="agreeCheck" onclick="toggleAgree()">
        <input type="checkbox" id="agreeBox" onclick="event.stopPropagation()" onchange="syncAgree()">
        <span>上記の同意事項に同意します</span>
      </label>
    </div>

    <div class="submit-error hidden" id="submitError"></div>
    <button class="submit-btn disabled" id="submitBtn" onclick="handleSubmit()" disabled>登録する</button>
    <p class="submit-hint">送信後、LINE友だち追加画面が表示されます</p>
  </div>
</div>

<div id="successPage" class="hidden">
  <div class="success-page">
    <div class="success-card">
      <div class="success-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <h2 style="font-size:22px;font-weight:900;margin-bottom:8px">ご登録ありがとうございます</h2>
      <p style="font-size:14px;opacity:0.85;line-height:1.7;margin-bottom:24px">登録内容を確認次第、ご連絡いたします。</p>
      <a href="https://line.me/R/ti/p/@864mbroc" target="_blank" class="line-btn line-btn-big">LINEで友だち追加する</a>
      <div id="countdown" class="countdown"></div>
      <div id="postUploadStatus" class="post-upload-status"></div>
      <button id="retryUploadBtn" class="post-upload-retry hidden" onclick="retryFailedUploads()">LINEを開く</button>
      <div class="success-note">画像はLINEで「店舗名」を先頭に記載して送信してください。</div>
    </div>
  </div>
</div>

<script>
var GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwaiDpnuDHVtv2IRjEbQj82l0UDF3ohVqVeEJKa1ndw2N6S2w6uUg5zQeaCjL_taBwV/exec';

(function initGoogleScriptRunShim() {
  try {
    if (window.google && google.script && google.script.run &&
        typeof google.script.run.withSuccessHandler === 'function') return;
  } catch (e) {}

  window.google = window.google || {};
  google.script = google.script || {};

  function callApi(action, payload) {
    return fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: action, payload: payload }),
      redirect: 'follow'
    }).then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.text();
    }).then(function(text) {
      try { return JSON.parse(text); } catch (e) { throw new Error('API応答エラー: ' + text.slice(0, 120)); }
    });
  }

  function createRunner() {
    var onSuccess = function(){};
    var onFailure = function(){};
    return {
      withSuccessHandler: function(fn) { onSuccess = fn || function(){}; return this; },
      withFailureHandler: function(fn) { onFailure = fn || function(){}; return this; },
      submitForm: function(payload) { callApi('submitForm', payload).then(onSuccess).catch(onFailure); },
      uploadSubmissionImage: function(payload) { callApi('uploadSubmissionImage', payload).then(onSuccess).catch(onFailure); }
    };
  }

  Object.defineProperty(google.script, 'run', { get: function() { return createRunner(); } });
})();

// ====== STATE ======
var scheduleType = 'daily';
var holidays = [];
var targets = [];
var agreed = false;
var submitting = false;
var submitWatchdogTimer = null;
var postSubmitUploading = false;
var postUploadSession = null;

var LINE_URL = 'https://line.me/R/ti/p/@864mbroc';
var DAYS = ['月','火','水','木','金','土','日'];
var TARGET_OPTIONS = [
  {id:'couple',label:'カップル'},{id:'family',label:'ファミリー'},
  {id:'solo',label:'おひとりさま'},{id:'group',label:'団体'},
  {id:'drinking',label:'飲み会'},{id:'dinner',label:'ディナー'},
  {id:'lunch',label:'ランチ'},{id:'dessert',label:'デザート'}
];
var BENEFIT_TYPES = ['discount', 'drink', 'side', 'sizeUp'];
var DRAFT_KEY = 'flying_pass_partner_form_draft_v1';
var autosaveBound = false;
var saveTimer = null;
var UTILITY_CHECK_IDS = [
  'utilPayCredit','utilPayPaypay','utilPayAlipay','utilPayCash',
  'utilLangKoMenu','utilLangEnMenu','utilLangKoStaff',
  'utilAmenityWifi','utilAmenitySmoking','utilAmenityNoSmoking','utilAmenityChildChair','utilAmenityOutlet'
];

// ====== INIT ======
window.onload = function() {
  buildTimeOptions();
  buildHolidayBtns();
  buildWeeklySection();
  buildTargetBtns();
  restoreDraft();
  syncCheckChipStates();
  bindAutosave();
};

// ====== PAGE NAVIGATION ======
function showForm() {
  document.getElementById('infoPage').classList.add('hidden');
  document.getElementById('formPage').classList.remove('hidden');
  window.scrollTo(0,0);
}
function showInfo() {
  document.getElementById('formPage').classList.add('hidden');
  document.getElementById('infoPage').classList.remove('hidden');
  window.scrollTo(0,0);
}
function showSuccess() {
  document.getElementById('formPage').classList.add('hidden');
  document.getElementById('successPage').classList.remove('hidden');
  window.scrollTo(0,0);

  var count = 5;
  var el = document.getElementById('countdown');
  el.textContent = count + '秒後に自動でLINE画面が開きます...';
  var timer = setInterval(function(){
    count--;
    if(count <= 0){
      clearInterval(timer);
      el.textContent = '';
      window.open(LINE_URL, '_blank');
    } else {
      el.textContent = count + '秒後に自動でLINE画面が開きます...';
    }
  }, 1000);
}

function setPostUploadStatus(text, isError) {
  var el = document.getElementById('postUploadStatus');
  if (!el) return;
  el.textContent = text || '';
  el.style.color = isError ? '#FCA5A5' : 'rgba(255,255,255,0.85)';
}

function setRetryUploadButton(show, label) {
  var btn = document.getElementById('retryUploadBtn');
  if (!btn) return;
  btn.textContent = label || 'LINEを開く';
  btn.className = 'post-upload-retry' + (show ? '' : ' hidden');
}

// ====== TIME OPTIONS ======
function buildTimeOptions() {
  var opts = '<option value="">--:--</option>';
  for (var h=6; h<=26; h++) {
    for (var m=0; m<60; m+=30) {
      if (h===26 && m>0) break;
      var hh = String(h).padStart(2, '0');
      var mm = String(m).padStart(2, '0');
      opts += '<option value="'+hh+':'+mm+'">'+hh+':'+mm+'</option>';
    }
  }
  ['dailyOpen','dailyClose','breakOpen','breakClose'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.innerHTML = opts;
  });
}

// ====== SCHEDULE ======
function setSchedule(type) {
  scheduleType = type;
  document.getElementById('optDaily').className = 'radio-opt' + (type==='daily' ? ' active' : '');
  document.getElementById('optWeekly').className = 'radio-opt' + (type==='weekly' ? ' active' : '');
  document.getElementById('dailySection').className = type==='daily' ? '' : 'hidden';
  document.getElementById('weeklySection').className = type==='weekly' ? '' : 'hidden';
  queueSaveDraft();
}
function toggleBreak() {
  var checked = document.getElementById('hasBreak').checked;
  document.getElementById('breakTimes').className = checked ? 'break-times' : 'break-times hidden';
  queueSaveDraft();
}

// ====== HOLIDAY ======
function buildHolidayBtns() {
  var html = '';
  DAYS.forEach(function(d){ html += '<button class="holiday-btn" onclick="toggleHoliday(\''+d+'\')">'+d+'</button>'; });
  html += '<button class="holiday-btn nenkyu" onclick="toggleHoliday(\'年中無休\')">年中無休</button>';
  document.getElementById('holidayBtns').innerHTML = html;
}
function toggleHoliday(day) {
  if (day === '年中無休') {
    holidays = ['年中無休'];
  } else {
    holidays = holidays.filter(function(d){ return d !== '年中無休'; });
    var idx = holidays.indexOf(day);
    if (idx >= 0) holidays.splice(idx,1);
    else holidays.push(day);
  }
  updateHolidayBtns();
  queueSaveDraft();
}
function updateHolidayBtns() {
  var btns = document.getElementById('holidayBtns').children;
  for (var i=0; i<btns.length; i++) {
    var text = btns[i].textContent;
    var isNenkyu = text === '年中無休';
    var isActive = holidays.indexOf(text) >= 0;
    btns[i].className = 'holiday-btn' + (isNenkyu ? ' nenkyu' : '') + (isActive ? ' active' : '');
  }
}

// ====== WEEKLY ======
function buildWeeklySection() {
  var opts = '<option value="">--:--</option>';
  for (var h=6; h<=26; h++) {
    for (var m=0; m<60; m+=30) {
      if (h===26 && m>0) break;
      var hh = String(h).padStart(2, '0');
      var mm = String(m).padStart(2, '0');
      opts += '<option value="'+hh+':'+mm+'">'+hh+':'+mm+'</option>';
    }
  }

  var html = '';
  DAYS.forEach(function(d){
    html += '<div class="weekly-row" id="weekRow_'+d+'">';
    html += '<span class="weekly-day">'+d+'</span>';
    html += '<select class="time-select time-select-small" id="wOpen_'+d+'">'+opts+'</select>';
    html += '<span style="color:#94A3B8">〜</span>';
    html += '<select class="time-select time-select-small" id="wClose_'+d+'">'+opts+'</select>';
    html += '<label class="weekly-close-label"><input type="checkbox" id="wClosed_'+d+'" onchange="toggleWeekDay(\''+d+'\')">休み</label>';
    html += '</div>';
  });
  document.getElementById('weeklySection').innerHTML = html;
}
function toggleWeekDay(day) {
  var closed = document.getElementById('wClosed_'+day).checked;
  var row = document.getElementById('weekRow_'+day);
  row.className = 'weekly-row' + (closed ? ' closed' : '');
  document.getElementById('wOpen_'+day).style.display = closed ? 'none' : '';
  document.getElementById('wClose_'+day).style.display = closed ? 'none' : '';
  row.querySelectorAll('span')[0].style.display = closed ? 'none' : '';
  var dayEl = row.querySelector('.weekly-day');
  dayEl.className = 'weekly-day' + (closed ? ' off' : '');
  queueSaveDraft();
}

// ====== BENEFITS ======
function toggleBenefit(type) { selectSingleBenefit(type); }
function syncBenefit(type) { selectSingleBenefit(type); }
function updateBenefitRow(type, isChecked) {
  var map = {discount:'Discount', drink:'Drink', side:'Side', sizeUp:'SizeUp'};
  var row = document.getElementById('benefit'+map[type]);
  var maxDiv = document.getElementById('max'+map[type]);
  if (isChecked) {
    row.className = 'benefit-row active';
    maxDiv.className = 'benefit-max';
  } else {
    row.className = 'benefit-row';
    maxDiv.className = 'benefit-max hidden';
  }
  queueSaveDraft();
}
function selectSingleBenefit(type) {
  var map = {discount:'Discount', drink:'Drink', side:'Side', sizeUp:'SizeUp'};
  BENEFIT_TYPES.forEach(function(t){
    var chk = document.getElementById('chk' + map[t]);
    if (!chk) return;
    chk.checked = (t === type);
    updateBenefitRow(t, chk.checked);
  });
}
function getSelectedBenefitCount() {
  var map = {discount:'Discount', drink:'Drink', side:'Side', sizeUp:'SizeUp'};
  return BENEFIT_TYPES.reduce(function(acc, t){
    var chk = document.getElementById('chk' + map[t]);
    return acc + ((chk && chk.checked) ? 1 : 0);
  }, 0);
}
function normalizeBenefitSelectionFromDraft() {
  var map = {discount:'Discount', drink:'Drink', side:'Side', sizeUp:'SizeUp'};
  var selected = BENEFIT_TYPES.filter(function(t){
    var chk = document.getElementById('chk' + map[t]);
    return !!(chk && chk.checked);
  });
  if (selected.length > 1) { selectSingleBenefit(selected[0]); return; }
  BENEFIT_TYPES.forEach(function(t){
    var chk = document.getElementById('chk' + map[t]);
    updateBenefitRow(t, !!(chk && chk.checked));
  });
}

// ====== TARGET ======
function buildTargetBtns() {
  var html = '';
  TARGET_OPTIONS.forEach(function(t){
    html += '<button class="target-btn" id="target_'+t.id+'" onclick="toggleTarget(\''+t.id+'\')">'+t.label+'</button>';
  });
  document.getElementById('targetBtns').innerHTML = html;
}
function toggleTarget(id) {
  var idx = targets.indexOf(id);
  if (idx >= 0) targets.splice(idx,1);
  else targets.push(id);
  TARGET_OPTIONS.forEach(function(t){
    var el = document.getElementById('target_'+t.id);
    el.className = 'target-btn' + (targets.indexOf(t.id)>=0 ? ' active' : '');
  });
  queueSaveDraft();
}

// ====== POSTAL ======
function lookupPostalCode() {
  var postalEl = document.getElementById('postalCode');
  var btn = document.getElementById('postalSearchBtn');
  var raw = (postalEl.value || '').trim();
  var code = raw.replace(/\D/g, '');

  if (code.length !== 7) {
    alert('郵便番号は7桁で入力してください。');
    postalEl.focus();
    return;
  }

  btn.disabled = true;
  btn.textContent = '検索中...';

  fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + code)
    .then(function(res){ return res.json(); })
    .then(function(data){
      if (!data || data.status !== 200 || !data.results || !data.results.length) throw new Error('not found');
      var result = data.results[0];
      var areaText = (result.address1 || '') + (result.address2 || '');
      var areaEl = document.getElementById('area');
      if (!areaEl.value.trim()) areaEl.value = areaText;
      postalEl.value = code;
      queueSaveDraft();
    })
    .catch(function(){ alert('住所検索に失敗しました。郵便番号をご確認ください。'); })
    .finally(function(){ btn.disabled = false; btn.textContent = '住所検索'; });
}

// ====== AGREEMENT ======
function toggleAgree() {
  var chk = document.getElementById('agreeBox');
  chk.checked = !chk.checked;
  syncAgree();
}
function syncAgree() {
  var chk = document.getElementById('agreeBox');
  agreed = chk.checked;
  var el = document.getElementById('agreeCheck');
  el.className = 'agree-check' + (agreed ? ' active' : '');
  var btn = document.getElementById('submitBtn');
  btn.disabled = !agreed;
  btn.className = 'submit-btn ' + (agreed ? 'ready' : 'disabled');
  queueSaveDraft();
}

// ====== DRAFT ======
function bindAutosave() {
  if (autosaveBound) return;
  autosaveBound = true;
  var formPage = document.getElementById('formPage');
  if (formPage) {
    formPage.addEventListener('input', queueSaveDraft);
    formPage.addEventListener('change', queueSaveDraft);
    formPage.addEventListener('change', syncCheckChipStates);
  }
  window.addEventListener('beforeunload', saveDraft);
}
function queueSaveDraft() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDraft, 150);
}
function getFieldValue(id) {
  var el = document.getElementById(id);
  return el ? el.value : '';
}
function setFieldValue(id, value) {
  var el = document.getElementById(id);
  if (el && typeof value !== 'undefined' && value !== null) el.value = value;
}
function collectDraft() {
  var weekly = {};
  DAYS.forEach(function(d){
    weekly[d] = {
      open: getFieldValue('wOpen_' + d),
      close: getFieldValue('wClose_' + d),
      closed: !!(document.getElementById('wClosed_' + d) && document.getElementById('wClosed_' + d).checked)
    };
  });

  return {
    scheduleType: scheduleType,
    holidays: holidays.slice(),
    targets: targets.slice(),
    agreed: agreed,
    fields: {
      companyName: getFieldValue('companyName'),
      contactName: getFieldValue('contactName'),
      contactInfo: getFieldValue('contactInfo'),
      email: getFieldValue('email'),
      category: getFieldValue('category'),
      postalCode: getFieldValue('postalCode'),
      area: getFieldValue('area'),
      address: getFieldValue('address'),
      googleMapsUrl: getFieldValue('googleMapsUrl'),
      websiteUrl: getFieldValue('websiteUrl'),
      minAmount: getFieldValue('minAmount'),
      storeIntro: getFieldValue('storeIntro'),
      menu1: getFieldValue('menu1'),
      menu2: getFieldValue('menu2'),
      menu3: getFieldValue('menu3'),
      dailyOpen: getFieldValue('dailyOpen'),
      dailyClose: getFieldValue('dailyClose'),
      hasBreak: !!(document.getElementById('hasBreak') && document.getElementById('hasBreak').checked),
      breakOpen: getFieldValue('breakOpen'),
      breakClose: getFieldValue('breakClose'),
      chkDiscount: !!(document.getElementById('chkDiscount') && document.getElementById('chkDiscount').checked),
      chkDrink: !!(document.getElementById('chkDrink') && document.getElementById('chkDrink').checked),
      chkSide: !!(document.getElementById('chkSide') && document.getElementById('chkSide').checked),
      chkSizeUp: !!(document.getElementById('chkSizeUp') && document.getElementById('chkSizeUp').checked),
      maxDiscountAmt: getFieldValue('maxDiscountAmt'),
      maxDrinkAmt: getFieldValue('maxDrinkAmt'),
      maxSideAmt: getFieldValue('maxSideAmt'),
      maxSizeUpAmt: getFieldValue('maxSizeUpAmt'),
      utilPayCredit: !!(document.getElementById('utilPayCredit') && document.getElementById('utilPayCredit').checked),
      utilPayPaypay: !!(document.getElementById('utilPayPaypay') && document.getElementById('utilPayPaypay').checked),
      utilPayAlipay: !!(document.getElementById('utilPayAlipay') && document.getElementById('utilPayAlipay').checked),
      utilPayCash: !!(document.getElementById('utilPayCash') && document.getElementById('utilPayCash').checked),
      utilLangKoMenu: !!(document.getElementById('utilLangKoMenu') && document.getElementById('utilLangKoMenu').checked),
      utilLangEnMenu: !!(document.getElementById('utilLangEnMenu') && document.getElementById('utilLangEnMenu').checked),
      utilLangKoStaff: !!(document.getElementById('utilLangKoStaff') && document.getElementById('utilLangKoStaff').checked),
      utilAmenityWifi: !!(document.getElementById('utilAmenityWifi') && document.getElementById('utilAmenityWifi').checked),
      utilAmenitySmoking: !!(document.getElementById('utilAmenitySmoking') && document.getElementById('utilAmenitySmoking').checked),
      utilAmenityNoSmoking: !!(document.getElementById('utilAmenityNoSmoking') && document.getElementById('utilAmenityNoSmoking').checked),
      utilAmenityChildChair: !!(document.getElementById('utilAmenityChildChair') && document.getElementById('utilAmenityChildChair').checked),
      utilAmenityOutlet: !!(document.getElementById('utilAmenityOutlet') && document.getElementById('utilAmenityOutlet').checked)
    },
    weekly: weekly
  };
}
function saveDraft() {
  try {
    var data = collectDraft();
    localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
  } catch (e) {}
}
function restoreDraft() {
  try {
    var raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return;
    var draft = JSON.parse(raw);
    if (!draft || !draft.fields) return;

    Object.keys(draft.fields).forEach(function(key){
      if (key === 'hasBreak' || key.indexOf('chk') === 0 || key.indexOf('util') === 0) return;
      setFieldValue(key, draft.fields[key]);
    });

    var hasBreakEl = document.getElementById('hasBreak');
    if (hasBreakEl) hasBreakEl.checked = !!draft.fields.hasBreak;
    toggleBreak();

    ['Discount', 'Drink', 'Side', 'SizeUp'].forEach(function(name){
      var el = document.getElementById('chk' + name);
      if (el) el.checked = !!draft.fields['chk' + name];
    });
    normalizeBenefitSelectionFromDraft();

    scheduleType = draft.scheduleType === 'weekly' ? 'weekly' : 'daily';
    setSchedule(scheduleType);

    if (draft.weekly) {
      DAYS.forEach(function(d){
        var item = draft.weekly[d] || {};
        setFieldValue('wOpen_' + d, item.open || '');
        setFieldValue('wClose_' + d, item.close || '');
        var closedEl = document.getElementById('wClosed_' + d);
        if (closedEl) closedEl.checked = !!item.closed;
        toggleWeekDay(d);
      });
    }

    holidays = Array.isArray(draft.holidays) ? draft.holidays : [];
    updateHolidayBtns();

    targets = Array.isArray(draft.targets) ? draft.targets : [];
    TARGET_OPTIONS.forEach(function(t){
      var el = document.getElementById('target_' + t.id);
      if (el) el.className = 'target-btn' + (targets.indexOf(t.id)>=0 ? ' active' : '');
    });

    var agreeEl = document.getElementById('agreeBox');
    if (agreeEl) agreeEl.checked = !!draft.agreed;
    UTILITY_CHECK_IDS.forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.checked = !!draft.fields[id];
    });
    syncCheckChipStates();
    syncAgree();
  } catch (e) {}
}
function clearDraft() {
  try { localStorage.removeItem(DRAFT_KEY); } catch (e) {}
}

// ====== BUILD FORM DATA ======
function getBusinessHours() {
  if (scheduleType === 'daily') {
    var open = document.getElementById('dailyOpen').value || '--:--';
    var close = document.getElementById('dailyClose').value || '--:--';
    var text = open + ' 〜 ' + close;
    if (document.getElementById('hasBreak').checked) {
      var bo = document.getElementById('breakOpen').value || '--:--';
      var bc = document.getElementById('breakClose').value || '--:--';
      text += ' / 休憩 ' + bo + ' 〜 ' + bc;
    }
    return text;
  } else {
    var parts = [];
    DAYS.forEach(function(d){
      if (document.getElementById('wClosed_'+d).checked) parts.push(d + ': 休み');
      else {
        var o = document.getElementById('wOpen_'+d).value || '--:--';
        var c = document.getElementById('wClose_'+d).value || '--:--';
        parts.push(d + ': ' + o + ' 〜 ' + c);
      }
    });
    return parts.join(' / ');
  }
}
function getHolidays() {
  if (scheduleType === 'weekly') {
    var closed = [];
    DAYS.forEach(function(d){ if (document.getElementById('wClosed_'+d).checked) closed.push(d); });
    return closed.length > 0 ? closed.join('・') : 'なし';
  }
  return holidays.length > 0 ? holidays.join('・') : '未選択';
}

// ====== SUBMIT ======
function handleSubmit() {
  if (!agreed || submitting) return;

  var required = ['companyName','contactName','contactInfo','email','category','area','address','googleMapsUrl','minAmount','storeIntro'];
  for (var i=0; i<required.length; i++) {
    var val = document.getElementById(required[i]).value.trim();
    if (!val) {
      alert('必須項目をすべてご入力ください。');
      document.getElementById(required[i]).focus();
      return;
    }
  }
  if (getSelectedBenefitCount() !== 1) {
    alert('特典内容は1つだけ選択してください。');
    return;
  }

  submitting = true;
  var btn = document.getElementById('submitBtn');
  btn.innerHTML = '<div class="spinner"></div> 送信中...';
  btn.className = 'submit-btn disabled';
  document.getElementById('submitError').classList.add('hidden');

  clearTimeout(submitWatchdogTimer);
  submitWatchdogTimer = setTimeout(function(){
    if (!submitting) return;
    submitting = false;
    btn.innerHTML = '登録する';
    btn.className = 'submit-btn ready';
    var timeoutErr = document.getElementById('submitError');
    timeoutErr.textContent = '送信に時間がかかっています。通信環境をご確認のうえ再試行してください。';
    timeoutErr.classList.remove('hidden');
  }, 120000);

  var menus = [
    document.getElementById('menu1').value,
    document.getElementById('menu2').value,
    document.getElementById('menu3').value
  ].filter(function(m){ return m.trim(); }).join(' / ');

  var targetLabels = targets.map(function(id){
    var t = TARGET_OPTIONS.find(function(o){ return o.id === id; });
    return t ? t.label : id;
  }).join('・');

  var formData = {
    companyName: document.getElementById('companyName').value,
    contactName: document.getElementById('contactName').value,
    contactInfo: document.getElementById('contactInfo').value,
    email: document.getElementById('email').value,
    postalCode: document.getElementById('postalCode').value,
    category: document.getElementById('category').value,
    area: document.getElementById('area').value,
    address: document.getElementById('address').value,
    googleMapsUrl: document.getElementById('googleMapsUrl').value,
    websiteUrl: document.getElementById('websiteUrl').value,
    minAmount: document.getElementById('minAmount').value,
    benefits: {
      discount: { checked: document.getElementById('chkDiscount').checked, maxAmount: document.getElementById('maxDiscountAmt').value },
      drink: { checked: document.getElementById('chkDrink').checked, maxAmount: document.getElementById('maxDrinkAmt').value },
      side: { checked: document.getElementById('chkSide').checked, maxAmount: document.getElementById('maxSideAmt').value },
      sizeUp: { checked: document.getElementById('chkSizeUp').checked, maxAmount: document.getElementById('maxSizeUpAmt').value }
    },
    businessHours: getBusinessHours(),
    holidays: getHolidays(),
    storeIntro: document.getElementById('storeIntro').value,
    recommendedMenus: menus,
    targets: targetLabels,
    paymentMethods: collectCheckedLabels([
      { id: 'utilPayCredit', label: 'クレジットカード' },
      { id: 'utilPayPaypay', label: 'PayPay' },
      { id: 'utilPayAlipay', label: 'Alipay' },
      { id: 'utilPayCash', label: '現金' }
    ]),
    languageSupport: collectCheckedLabels([
      { id: 'utilLangKoMenu', label: '韓国語メニュー' },
      { id: 'utilLangEnMenu', label: '英語メニュー' },
      { id: 'utilLangKoStaff', label: '韓国語対応スタッフ' }
    ]),
    amenities: collectCheckedLabels([
      { id: 'utilAmenityWifi', label: '無料Wi-Fi' },
      { id: 'utilAmenitySmoking', label: '喫煙席あり' },
      { id: 'utilAmenityNoSmoking', label: '全席禁煙' },
      { id: 'utilAmenityChildChair', label: '子ども用椅子' },
      { id: 'utilAmenityOutlet', label: 'コンセント' }
    ]),
    images: []
  };

  google.script.run
    .withSuccessHandler(function(result){
      clearTimeout(submitWatchdogTimer);
      submitting = false;
      if (result && result.success) {
        var storeName = (formData.companyName || '').trim() || '未入力';
        clearDraft();
        showSuccess();
        setPostUploadStatus('画像はLINEで送ってください（店舗名: ' + storeName + '）');
        setRetryUploadButton(true, 'LINEを開く');
      } else {
        btn.innerHTML = '登録する';
        btn.className = 'submit-btn ready';
        var errEl = document.getElementById('submitError');
        errEl.textContent = (result && result.message) || '送信中にエラーが発生しました。もう一度お試しください。';
        errEl.classList.remove('hidden');
      }
    })
    .withFailureHandler(function(){
      clearTimeout(submitWatchdogTimer);
      submitting = false;
      btn.innerHTML = '登録する';
      btn.className = 'submit-btn ready';
      var errEl = document.getElementById('submitError');
      errEl.textContent = '送信中にエラーが発生しました。もう一度お試しください。';
      errEl.classList.remove('hidden');
    })
    .submitForm(formData);
}

function retryFailedUploads() { window.open(LINE_URL, '_blank'); }

function syncCheckChipStates() {
  var chips = document.querySelectorAll('.check-chip');
  for (var i=0; i<chips.length; i++) {
    var chk = chips[i].querySelector('input[type="checkbox"]');
    if (!chk) continue;
    chips[i].className = 'check-chip' + (chk.checked ? ' active' : '');
  }
}
function collectCheckedLabels(items) {
  return items.filter(function(item){
    var el = document.getElementById(item.id);
    return !!(el && el.checked);
  }).map(function(item){
    return item.label;
  }).join(' / ');
}
</script>
</body>
</html>
